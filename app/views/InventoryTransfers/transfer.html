#{extends 'CRUD/layout.html' /}
#{set activeMenu:'Inventory'/}
#{set activeMenuSub:'InventoryTransfer'/}
#{jqueryui-config /}
#{fileupload-config /}
#{ckeditor-config /}
#{fancybox-config /}
#{checkFileExtension /}
#{flashCrud /}
<script type="text/javascript" src="@{'/public/javascripts/validateOnlyNumber.js'}"></script>
<script src="/public/javascripts/jquery.resizableColumns.min.js"></script>

%{inventoryPermission = user.getUserPermissionType(controllers.Consts.permissionInventory);}%
%{inventoryProjectPermission = user.getPermissionType(controllers.Consts.permissionInventory);}%
<div id="main-content"
     class="dhidden" ${inventoryPermission==3 || inventoryProjectPermission==4 || inventoryProjectPermission==5 ? "" : "hidden=\"true\""}>
    <div>
        <div class="m-b-0 clearfix">
            <div class="page-title pull-left">
                <h3 class="pull-left"><strong>&{'Transfer'}</strong></h3>
            </div>
            <div class="pull-right">
            #{if inventoryPermission==3 || inventoryProjectPermission==4 || inventoryProjectPermission==5}
                <button id="maketransfer_btn" class="btn btn-success m-t-10" data-toggle="modal" data-target="#modal-maketransfer"><i
                        class="fa fa-plus p-r-10"></i> &{'make_transfer'}</button>
            #{/if}
            </div>
        </div>
        <div class="row"
             id="status-row">
            <div class="col-md-3  m-b-10" style=" padding: 0; padding-right: 6px;">
                <a href="@{controllers.InventoryTransfers.viewAll()}"
                   class="btn btn-${status=="0" && to_filter == "0" && from_filter == "0" && return_filter == "0" && keyword == "" ? 'dark ' : 'default'}"
                   style="width: 100%">&{'All'}
                    <span class="label label-${status=="0" && to_filter == "0" && from_filter == "0" && return_filter == "0" && keyword == "" ? 'primary' : 'default'} m-l-10">#{if all<100}${all}#{/if}#{else}+99#{/else}</span></a>
            </div>
            <div class="col-md-3  m-b-10" style=" padding: 0; padding-right: 6px">
                <a href="@{controllers.InventoryTransfers.transfer(1,null, null, "", "0", "0", "0", "1", message)}"
                   class="btn btn-${status=="1" && to_filter == "0" && from_filter == "0" && return_filter == "0" && keyword == "" ? 'dark ' : 'default'}"
                   style="width: 100%">&{'transfered'} <span
                        class="label label-${status=="1" && to_filter == "0" && from_filter == "0" && return_filter == "0" && keyword == "" ? 'primary' : 'default'} m-l-10">#{if transfered<100}${transfered}#{/if}#{else}+99#{/else}</span></a>
            </div>
            <div class="col-md-3  m-b-10" style=" padding: 0; padding-right: 6px">
                <a href="@{controllers.InventoryTransfers.transfer(1,null, null, "", "0", "0", "0", "2", message)}"
                   class="btn btn-${status=="2" && to_filter == "0" && from_filter == "0" && return_filter == "0" && keyword == "" ? 'dark ' : 'default'}"
                   style="width: 100%">&{'recieved'} <span
                        class="label label-${status=="2" && to_filter == "0" && from_filter == "0" && return_filter == "0" && keyword == "" ? 'primary' : 'default'} m-l-10">#{if recieved<100}${recieved}#{/if}#{else}+99#{/else}</span></a>
            </div>
            <div class="col-md-3  m-b-10" style=" padding: 0; padding-right: 6px">
                <a href="@{controllers.InventoryTransfers.transfer(1,null, null, "", "0", "0", "0", "3", message)}"
                   class="btn btn-${status=="3" && to_filter == "0" && from_filter == "0" && return_filter == "0" && keyword == "" ? 'dark ' : 'default'}"
                   style="width: 100%">&{'cancelled'} <span
                        class="label label-${status=="3" && to_filter == "0" && from_filter == "0" && return_filter == "0" && keyword == "" ? 'primary' : 'default'} m-l-10">#{if cancelled<100}${cancelled}#{/if}#{else}+99#{/else}</span></a>
            </div>
        </div>
        <div class="row" class=" m-b-10"
             id="filter-row">
            <form id="filterForm" action="@{InventoryTransfers.transfer()}" method="get">
                <div class="col-md-2" style=" padding: 0; padding-right: 6px">
                    <div id="reportrange" class="form-control m-b-10" style="padding-left: 10px;padding-right: 10px;">
                        <i class="fa fa-calendar fa-lg p-r-0"></i><span>#{if filterStartDate=="" && filterEndDate==""}
                        Өдрөөр хайх...#{/if}#{else}${filterStartDate}
                        -${filterEndDate}#{/else}</span>
                        <input type="text" hidden="true" name="filterStartDate" id="filter_start"
                               value="${filterStartDate}"/>
                        <input type="text" hidden="true" name="filterEndDate" id="filter_end"
                               value="${filterEndDate}"/>
                    </div>
                </div>
                <div class="col-md-3" style="padding: 0; padding-right: 6px;">
                    <select data-live-search="true" id="from_filter"
                            class="form-control" name="from_filter">
                        <option value="0">&{'Шилжүүлэх байршил'}</option>
                        <option data-divider="true"></option>
                    #{list items:Locations,as: 'location'}
                        <option value="${location.id}" ${location.id.toString() == from_filter ? 'selected' : ''}>${location.name}</option>
                    #{/list}
                    </select>
                </div>
                <div class="col-md-3" style="padding: 0; padding-right: 6px;">
                    <select data-live-search="true" id="to_filter"
                            class="form-control" name="to_filter">
                        <option value="0">&{'Хүлээн авах байршил'}</option>
                        <option data-divider="true"></option>
                    #{list items:Locations,as: 'location'}
                        <option value="${location.id}" ${location.id.toString() == to_filter ? 'selected' : ''}>${location.name}</option>
                    #{/list}
                    </select>
                </div>
                <div class="col-md-2" style="padding: 0; padding-right: 6px;">
                    <select data-live-search="true" id="return_filter"
                            class="form-control" name="return_filter">
                        <option value="0" ${return_filter=="0" ? 'selected' : ''} >&{'Type'}</option>
                        <option data-divider="true"></option>
                        <option value="1" ${return_filter=="1" ? 'selected' : ''}
                                data-icon="">&{'transfer'}
                        </option>
                        <option value="2" ${return_filter=="2" ? 'selected' : ''}
                                data-icon="fa-refresh">&{'return'}
                        </option>
                    </select>
                </div>
                <div class="col-md-1" style="padding: 0; padding-right: 6px;">
                    <input type="text" class="form-control" style=";"
                           placeholder="&{'Search'}!" name="keyword" value="${keyword}"/>
                </div>
                <div class="col-md-1" style="padding: 0;">
                    <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
                </div>
                <div class="col-md-2" style="padding: 0;">
                    <input type="hidden" name="CurrentPageNumber" value="1"/>
                </div>
            </form>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-12 col-sm-12 col-xs-12 table-responsive">
                                <table style="font-weight: 500;" id="products-table"
                                       class="table table-tools table-hover"
                                       data-resizable-columns-id="inventorytransfer-resizalbe-table">
                                    <thead>
                                    <tr>
                                        <th style="width: 100px;text-align: center" data-resizable-column-id="#">
                                            <strong>&{'#'}</strong>
                                        </th>
                                        <th style="width: auto;text-align: center" data-resizable-column-id="items">
                                            <strong>&{'items'}</strong>
                                        </th>
                                        <th style="width: auto;text-align: center" data-resizable-column-id="from">
                                            <strong>&{'from'}</strong>
                                        </th>
                                        <th style="width: auto;text-align: center" data-resizable-column-id="to">
                                            <strong>&{'to'}</strong>
                                        </th>
                                        <th style="width: 10%;text-align: center" data-resizable-column-id="status">
                                            <strong>&{'status'}</strong>
                                        </th>
                                        <th style="width: 80px!important;text-align: center"
                                            data-resizable-column-id="date">
                                            <strong>&{'date'}</strong>
                                        </th>
                                        <th style="width: 80px!important;text-align: center"
                                            data-resizable-column-id="date">
                                            <strong>&{'transfer_recieve_date'}</strong>
                                        </th>
                                        <th style="width: 30px!important;text-align: center"
                                            data-resizable-column-id="date">
                                            <strong></strong>
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    #{list items:Transfers, as: 'transfer'}
                                    <tr>
                                        <td><strong>${transfer.id}</strong> #{if transfer.isReturn}<i
                                                class="fa fa-refresh"></i>#{/if}</td>
                                        <td>
                                            #{list items:transfer.inventorys, as: 'inventory'}
                                                #{if inventory_index<10}
                                                    #{if inventory_isLast}
                                                    ${inventory.inventory.item}.
                                                    #{/if}
                                                    #{else}
                                                    ${inventory.inventory.item},
                                                    #{/else}
                                                #{/if}
                                                #{if inventory_index==10}
                                                ${inventory.inventory.item}.
                                                #{/if}
                                            #{/list}
                                        </td>
                                        <td>${transfer.from.name}</td>
                                        <td>${transfer.to.name}</td>
                                        <td>
                                            <span class="${transfer.status.id==1 ? "col-md-12 label label-primary" :(transfer.status.id==2 ? "col-md-12 label label-success" :(transfer.status.id==3 ? "col-md-12 label label-danger" :"col-md-12 label label-default"))}">${transfer.status.status}</span>
                                        </td>
                                        <td style="width: 80px!important;">${transfer.date.format("yy/MM/dd")}</td>
                                        <td style="width: 80px!important;">#{if transfer.recieved_date!=null}${transfer.recieved_date.format("yy/MM/dd")}#{/if}#{elseif}#{/elseif}</td>
                                        <td style="width: 30px!important;">#{if transfer.hasAttachment()}<i class="fa fa-file"></i>#{/if}</td>
                                    </tr>
                                    #{/list}
                                    </tbody>
                                </table>
                            #{if MaxPageNumber>1}
                                <div class="page-navigation" style="width: 100%; text-align: right;">
                                    <a style="text-decoration: none;"
                                       href="@{InventoryTransfers.transfer(CurrentPageNumber - 1,filterStartDate,filterEndDate,keyword,from_filter,to_filter,return_filter,status,message)}">
                                        <input
                                                class="number-button btn btn-default" ${ CurrentPageNumber - 1 <= 0 ? 'disabled': ''}
                                                style="padding-top: 5px; padding-bottom: 5px; padding-left: 10px; padding-right: 10px;"
                                                type="button"
                                                value="<"/>
                                    </a>
                                %{
                                    int threeDots = 0;
                                    for(int i = 1; i <= MaxPageNumber; i++){
                                    if( i == 1 || i == MaxPageNumber || (CurrentPageNumber < 3 && i < 5) ||
                                    (CurrentPageNumber - 1 <= i && i <= CurrentPageNumber + 1) ||
                                    (CurrentPageNumber > MaxPageNumber - 2 && i > MaxPageNumber - 4) ){
                                    }%
                                    <a style="text-decoration: none;"
                                       #{if CurrentPageNumber != i}href="@{InventoryTransfers.transfer(i,filterStartDate,filterEndDate,keyword,from_filter,to_filter,return_filter,status,message)}"#{/if}>
                                        <input
                                                class="number-button btn btn-${CurrentPageNumber == i ? 'dark':'default'}"
                                                style="padding-top: 5px; padding-bottom: 5px; padding-left: 10px; padding-right: 10px;"
                                                type="button"
                                                value="${i}"/>
                                    </a>
                                %{ }else{
                                    if( i == 2 || i == MaxPageNumber - 1 ){
                                    threeDots = 1;
                                    }
                                    if(threeDots == 1){
                                    }%
                                    <span style="font-size: x-large;"><strong>...</strong></span>
                                %{
                                    threeDots = 0;
                                    }
                                    }
                                    }
                                    }%
                                    <a style="text-decoration: none;"
                                       href="@{InventoryTransfers.transfer(CurrentPageNumber + 1,filterStartDate,filterEndDate,keyword,from_filter,to_filter,return_filter,status,message)}">
                                        <input
                                                class="number-button btn btn-default" ${ CurrentPageNumber >= MaxPageNumber ? 'disabled': ''}
                                                style="padding-top: 5px; padding-bottom: 5px; padding-left: 10px; padding-right: 10px;"
                                                type="button"
                                                value=">"/>
                                    </a>
                                </div>
                            #{/if}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

#{include "SharedView/AttachsMulti.html"/}

    <div class="modal fade" id="modal-maketransfer" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="width: 1150px;">
            <div class="modal-content">
                <div class="modal-header" >
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title"><strong>&{'make_transfer'}</strong></h4>
                </div>
                <div class="modal-body">
                    <form action="@{InventoryTransfers.transferItem()}" class="form-horizontal" method="get"
                          accept-charset="utf-8"
                          enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="tabcordion">
                                    <div id="myTabContent" class="tab-content">
                                        <div class="tab-pane fade active in" id="product_general">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="form-group">

                                                        <div class="col-md-12">
                                                            <div class="panel-body">
                                                                <div class="row">
                                                                    <div class="col-md-12 m-b-30">
                                                                        <div class="col-md-5">
                                                                            <div class="row m-b-10">
                                                                                <div class="col-md-6">
                                                                                    <label class="control-label"
                                                                                           style="font-size: larger;"><strong>&{'from_location'}:</strong>
                                                                                    </label>
                                                                                </div>
                                                                                <div class="col-md-6"><select
                                                                                        data-live-search="true"
                                                                                        name="from"
                                                                                        data-width="200px"
                                                                                        id="location_from_add"
                                                                                        title="&{'from_location'}"
                                                                                        required="true">
                                                                                </select></div>
                                                                            </div>
                                                                            <div class="row m-b-10">
                                                                                <div class="col-md-6">
                                                                                    <label class="control-label"
                                                                                           style="font-size: larger;"><strong>&{'transferer'}:</strong>
                                                                                    </label>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <label class="control-label"
                                                                                           style="font-size: larger;">${controllers.Users.getUser().lastnameFirstCharacter}
                                                                                        .${controllers.Users.getUser().firstName}</label>
                                                                                </div>
                                                                            </div>

                                                                        </div>
                                                                        <div class="col-md-5">
                                                                            <div class="row m-b-10">
                                                                                <div class="col-md-6">
                                                                                    <label class="control-label"
                                                                                           style="font-size: larger"><strong>&{'to_location'}:</strong>
                                                                                    </label>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <select data-live-search="true"
                                                                                            name="to"
                                                                                            data-width="200px"
                                                                                            id="location_to_add"
                                                                                            title="&{'to_location'}"
                                                                                            required="true">
                                                                                    #{list items:Locations,as:"location"}
                                                                                        <option value="${location.name}">
                                                                                        ${location.name}
                                                                                        </option>#{/list}</select>
                                                                                </div>

                                                                            </div>
                                                                            <div class="row m-b-10">
                                                                                <div class="col-md-6">
                                                                                    <label class="control-label"
                                                                                           style="font-size: larger"><strong>&{'reciever'}:</strong>
                                                                                    </label>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <select data-live-search="true"
                                                                                            name="reciever"
                                                                                            id="reciever_add"
                                                                                            data-width="200px"
                                                                                            title="&{'reciever'}"
                                                                                            required="true">
                                                                                    </select>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-2">
                                                                            <label>
                                                                                <input type="checkbox" name="isReturn">
                                                                            &{'is_return'}
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-12 col-sm-12 col-xs-12 table-responsive table-red">
                                                                        <table class="table table-striped table-hover dataTable"
                                                                               id="table-editable_add">
                                                                            <thead>
                                                                            <tr >
                                                                                <th style="width: 220px!important;align-content: center">&{'item'}</th>
                                                                                <th style="width: auto;align-content: center">&{'quantity'}</th>
                                                                                <th style="width: auto;align-content: center">&{'location_left'}</th>
                                                                                <th style="width: auto;align-content: center">&{'location_left'}</th>
                                                                                <th style="width: 100px;align-content: center">&{'measure'}</th>
                                                                                <th style="width: 200px;align-content: center">&{'note'}</th>
                                                                                <th style="width: 100px;align-content: center">&{'attachment'}</th>
                                                                                <th style="width: 45px!important;align-content: center"></th>
                                                                            </tr>
                                                                            </thead>
                                                                            <tfoot>
                                                                            <tr>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td>
                                                                                    <div class="text-center"><a
                                                                                            id="table-edit_new"
                                                                                            style="height: 24px!important; padding-top: 1px!important;"
                                                                                            class="add btn btn-icon-sm btn-rounded btn-default"
                                                                                            href="#"><i
                                                                                            class="fa fa-plus"></i></a>
                                                                                    </div>
                                                                                </td>
                                                                            </tr>
                                                                            </tfoot>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 m-t-20 m-b-40 align-center">
                                <button type="button" id="add_submit" class="btn btn-success m-t-10"><i
                                        class="fa fa-check"></i> &{'send'}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="modal-edittransfer" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="width: 1150px;">
            <div class="modal-content">
                <div class="modal-header" >
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title"><strong>&{'transfer'}</strong></h4>
                </div>
                <div class="modal-body">
                </div>

            </div>
        </div>
    </div>
</div>
<script>
    var picOpt = {
        monthsFull: ["Нэгдүгээр сар", "Хоёрдугаар сар", "Гуравдугаар сар", "Дөрөвдүгээр сар", "Тавдугаар сар", "Зургаадугаар сар", "Долдугаар сар", "Наймдугаар сар", "Есдүгээр сар", "Арав дугаар сар", "Арван нэгдүгээр сар", "Арван хоёрдугаар сар"],
        monthsShort: ["1 сар", "2 сар", "3 сар", "4 сар", "5 сар", "6 сар", "7 сар", "8 сар", "9 сар", "10 сар", "11 сар", "12 сар"],
        weekdaysFull: ["Даваа", "Мягмар", "Лхагва", "Пүрэв", "Баасан", "Бямба", "Ням"],
        weekdaysShort: ["Да", "Мя", "Лха", "Пү", "Ба", "Бя", "Ня"],

        // Today and clear
        today: 'Өнөөдөр',
        clear: 'Арилгах',

        // The format to show on the `input` element
        format: 'yyyy-mm-d'

    };
    $(window).load(function () {
        $('#modal-maketransfer #table-edit_new').click();
        $('div#main-content').removeClass('dhidden');
        $(function () {
            $("table").resizableColumns({
                store: window.store
            });
        });
    });
    $(document).ready(function () {


        $('.pickadate').each(function () {
            $(this).pickadate(picOpt);
        });
        var opt = {};

        // Tools: export to Excel, CSV, PDF & Print
        opt.sDom = "",
                opt.oLanguage = {"sSearch": "", 'sEmptyTable': "Үр дүн байхгүй байна."} ,
                opt.iDisplayLength = 40,

                opt.oTableTools = {
                    "sSwfPath": "/assets/plugins/datatables/swf/copy_csv_xls_pdf.swf",
                    "aButtons": ["csv", "xls", "pdf", "print"]
                };
        opt.aaSorting = [[0, 'desc']]
        opt.aoColumnDefs = [
            {'bSortable': false, 'aTargets': [0,1,2,3,4,5,6]}
        ];


        var data = ["", "", ""];
        var oTable = $('#products-table').dataTable(opt);
        oTable.fnDraw();

        var oTable_edit = $('#table-editable_edittransfer').dataTable({
            "aLengthMenu": [
                [5, 15, 20, -1],
                [5, 15, 20, "All"] // change per page values here
            ],
            "sDom": "",
            "oTableTools": {
                "sSwfPath": "/assets/plugins/datatables/swf/copy_csv_xls_pdf.swf"
            },
            // set the initial value
            "iDisplayLength": 10,
            "bPaginate": false,
            "sPaginationType": "bootstrap",
            "oLanguage": {
                'sEmptyTable': "Үр дүн байхгүй байна.",
                "sLengthMenu": "_MENU_ records per page",
                "oPaginate": {
                    "sPrevious": "Prev",
                    "sNext": "Next"
                },
                "sSearch": ""
            },
            "aoColumnDefs": [{
                'bSortable': false,
                'aTargets': [0, 1, 2, 3, 4]
            }
            ]
        });
        var oTable_add = $('#table-editable_add').dataTable({
            "aLengthMenu": [
                [5, 15, 20, -1],
                [5, 15, 20, "All"] // change per page values here
            ],
            "sDom": "",
            "oTableTools": {
                "sSwfPath": "/assets/plugins/datatables/swf/copy_csv_xls_pdf.swf"
            },
            // set the initial value
            "iDisplayLength": 10,
            "bPaginate": false,
            "sPaginationType": "bootstrap",
            'oLanguage': {
                'sEmptyTable': "Үр дүн байхгүй байна."
            },
            "aoColumnDefs": [{
                'bSortable': false,
                'aTargets': [0, 1, 2, 3, 4, 5]
            }
            ]
        });
        /* Add a placeholder to searh input */
        $('.dataTables_filter input').attr("placeholder", "Search a order...");

        /* Delete a product */

        var attachCount = 5;
        var dat = [""];
        var prev_size = 0;

        var u = '${user.id}';
        var user;
        var userper;

        $('table#products-table tbody tr').on('click', function (e) {
            e.preventDefault();
            var nRow = $(this);
            var index = $(nRow).find('td:nth-child(1) strong').html();

            $.ajax({
                type: "POST",
                data: {id: index},
                url: "/inventorytransfersedittransfer",
                beforeSend: function () {
                    $("div#modal-edittransfer").find("div.modal-body").html('<div style="width:100%; text-align: center"><img src="public/images/activity-indicator.gif"/></div>');
                    $('div#modal-edittransfer').modal('show');
                }
            }).success(
                    function (data) {
                        $('div#modal-edittransfer div.modal-body').html(data);
                    });


        });

        $('input#quantity_add').forceNumericOnly();


        $('div#modal-edittransfer button#edit_recieve').live('click', function (e) {
            e.preventDefault();
            var index = $('input#transfer_id_edit').val();
            $.ajax({
                type: "POST",
                data: $("div#modal-edittransfer form").serialize(),
                url: "/inventorytransfersrecievetransfer"
            }).success(
                    function (data) {
                        if (data == "success")
                            location.reload();
                        if (data == "failed") {
                            showErrorMessage("Амжилтүй боллоо.");
                        }
                    });

        });

        $('div#modal-edittransfer button#edit_cancel').live('click', function (e) {
            if (confirm("Та цуцлахдаа итгэлтэй байна уу?") == false) {
                return;
            }
            e.preventDefault();
            var index = $('input#transfer_id_edit').val();
            $.ajax({
                type: "POST",
                data: {id: index},
                url: "/inventorytransferscanceltransfer"
            }).success(
                    function (data) {
                        if (data == "success")
                            location.reload();
                        if (data == "failed") {
                            showErrorMessage("Амжилтүй боллоо.");
                        }
                    });

        });


        $('div#modal-maketransfer select#location_from_add').on('change', function () {


            $('div#modal-maketransfer table#table-editable_add tbody tr').each(function () {
                if ($(this).find("td.dataTables_empty").val() == null) {
                    var row = $(this);

                    var location_quantity = $(this).find("td:nth-child(3) input");

                    var item = $('select option:selected', $(this).find("td:first-child")).val();
                    if (item == null) {
                        item = $('input', $(this).find("td:first-child")).val();
                    }

                    $.ajax({
                        type: "POST",
                        data: {
                            inv: item,
                            loc: $('select#location_from_add option:selected').val()
                        },
                        url: "/inventoryordersgetlocationquantity"
                    }).success(
                            function (data) {
                                location_quantity.val(data);

                                if (parseFloat(data) < parseFloat($('input', row.find("td:nth-child(2)")).val())) {
                                    showErrorMessage("Шилжүүлэх хэмжээ агуулхын нөөцөөс их байж болохгүй.");
                                    $('input', row.find("td:nth-child(2)")).val("0");
                                }

                            });
                }
            });

        });



        $('button#maketransfer_btn').on('click',function(){});
        $.ajax({
            type: "POST",
            data: {
                loc: $('select#location_to_add option:selected').val()
            },
            url: "/inventorytransfersgetadmins"
        }).success(
                function (data) {
                    $('div#modal-maketransfer select#reciever_add').html("");
                    for (var i = 0; i < data.length; i = i + 3) {

                        $('div#modal-maketransfer select#reciever_add').append("<option value='" + data[i] + "'>" + data[i + 1] + " . " + data[i + 2] + " </option>");
                    }
                    $('div#modal-maketransfer select#reciever_add').selectpicker('refresh');

                });

        $.ajax({
            type: "POST",
            url: "/inventorytransfersgetmylcations"
        }).success(
                function (data) {
                    if (data.length > 0) {
                        $('div#modal-maketransfer select#location_from_add').html("");
                        for (var i = 0; i < data.length; i = i + 2) {
                            $('div#modal-maketransfer select#location_from_add').append("<option value='" + data[i + 1] + "'>" + data[i + 1] + " </option>");
                        }
                        $('div#modal-maketransfer select#location_from_add').selectpicker('refresh');
                    }
                });

        $('div#modal-maketransfer select#location_to_add').on('change', function () {

            $.ajax({
                type: "POST",
                data: {
                    loc: $('select#location_to_add option:selected').val()
                },
                url: "/inventorytransfersgetadmins"
            }).success(
                    function (data) {
                        $('div#modal-maketransfer select#reciever_add').html("");
                        for (var i = 0; i < data.length; i = i + 3) {

                            $('div#modal-maketransfer select#reciever_add').append("<option value='" + data[i] + "'>" + data[i + 1] + " . " + data[i + 2] + " </option>");
                        }
//                        $('div#modal-maketransfer select#reciever_add').selectpicker('render');
                        $('div#modal-maketransfer select#reciever_add').selectpicker('refresh');

                    });

            $('div#modal-maketransfer table#table-editable_add tbody tr').each(function () {
                if ($(this).find("td.dataTables_empty").val() == null) {

                    var location_quantity = $(this).find("td:nth-child(4) input");

                    var item = $('select option:selected', $(this).find("td:first-child")).val();
                    if (item == null) {
                        item = $('input', $(this).find("td:first-child")).val();
                    }

                    $.ajax({
                        type: "POST",
                        data: {
                            inv: item,
                            loc: $('select#location_to_add option:selected').val()
                        },
                        url: "/inventoryordersgetlocationquantity"
                    }).success(
                            function (data) {
                                location_quantity.val(data);
                            });
                }
            });

        });


        function editableTable_add() {

            function editRow(oTable_add, nRow) {
                var jqTds = $('>td', nRow);

                var jqInputs = $('input', nRow);
                jqTds[0].innerHTML = '<select data-live-search="true" name="item" class="form-control input-sm" title="&{'item'}" required="true"><option></option>#{list items:Inventorys,as:"inventory"}<option value="${inventory.item}" >${inventory.item}</option>#{/list}</select>';

                $('select', jqTds[0]).val(jqInputs[0].value);
                $('select', jqTds[0]).selectpicker('render');

                $('select', jqTds[0]).on('change', function () {
                    var measure = $(this).parents('tr').find("td:nth-child(5) input");
                    $.ajax({
                        type: "POST",
                        data: {inv: $('select option:selected', jqTds[0]).val()},
                        url: "/inventoryordersgetmeasure"
                    }).success(
                            function (data) {
                                measure.val(data);
                            });


                });
                jqTds[1].innerHTML = '<input type="text" class="numberic form-control small" name="quantity" value="' + jqInputs[1].value + '">';

                $('input', jqTds[1]).on('change', function () {
                    if (parseFloat($(this).val()) > parseFloat($('input', jqTds[2]).val())) {
                        showErrorMessage("Шилжүүлэх хэмжээ агуулхын нөөцөөс их байж болохгүй.");
                        $(this).val("0");
                    }
                });

                $('div#modal-maketransfer tbody tr').each(function () {
                    $(this).find('td:nth-child(2) input').forceNumericOnly();
                });

                jqTds[2].innerHTML = '<input type="text" readonly class="form-control small" name="from_quantity" value="' + jqInputs[2].value + '">';
                jqTds[3].innerHTML = '<input type="text" readonly class="form-control small" name="to_quantity" value="' + jqInputs[3].value + '">';

                $('select', jqTds[0]).on('change', function () {

                    var select = $(this);
                    var item_count = 0;
                    $('div#modal-maketransfer table#table-editable_add tbody tr').each(function () {
                        if ($(this).find("td:first-child select").val() == select.val())
                            item_count++;
                    });
                    if (item_count > 1) {
                        showErrorMessage("Энэ материал өмнө нь нэмэгдсэн байна.");
                        oTable_add.fnDeleteRow(select.parents('tr')[0]);
                        $('#modal-maketransfer #table-edit_new').click();
                    }
                    else {
                        $.ajax({
                            type: "POST",
                            data: {
                                inv: $('select option:selected', jqTds[0]).val(),
                                loc: $('select#location_from_add option:selected').val()
                            },
                            url: "/inventoryordersgetlocationquantity"
                        }).success(
                                function (data) {
                                    select.parents('tr').find("td:nth-child(3) input").val(data);

                                    if (parseFloat($('input', jqTds[1]).val()) > parseFloat($('input', jqTds[2]).val())) {
                                        showErrorMessage("Шилжүүлэх хэмжээ агуулхын нөөцөөс их байж болохгүй.");
                                        $('input', jqTds[1]).val("0");
                                    }
                                });
                        $.ajax({
                            type: "POST",
                            data: {
                                inv: $('select option:selected', jqTds[0]).val(),
                                loc: $('select#location_to_add option:selected').val()
                            },
                            url: "/inventoryordersgetlocationquantity"
                        }).success(
                                function (data) {
                                    select.parents('tr').find("td:nth-child(4) input").val(data);
                                });
                    }

                });

                jqTds[4].innerHTML = '<input type="text" readonly class="form-control small" name="measure" value="' + jqInputs[4].value + '">';
                jqTds[5].innerHTML = '<td><textarea class="form-control valid" rows="1" style="width: 100%;resize: none;" name="note"></textarea></td>'
                jqTds[6].innerHTML = '<div hidden="hidden"></div><div><input type="hidden" class="form-control small" name="attach_number"></div><ul class="uploadBox" id="u' + attachCount + '"><li><span><button type="button" class="btn upload btn-default btn-icon-sm btn-rounded" data-rel="tooltip" title="Хавсаргах"><i class="fa fa-cloud-upload"></i></button></span></li></ul>';
                jqTds[7].innerHTML = '<div class="text-center"><a style="padding-right: 11px;padding-left: 11px" class="delete btn btn-icon-sm btn-rounded btn-default" href=""><i class="fa fa-times-circle"></i></a></div>';
                attachCount++;
                $('select', nRow).selectpicker();
            }


            jQuery('#table-edit_wrapper .dataTables_filter input').addClass("form-control medium"); // modify table search input
            jQuery('#table-edit_wrapper .dataTables_length select').addClass("form-control xsmall"); // modify table per page dropdown


            $('#modal-maketransfer #table-edit_new').live('click', function (e) {
                e.preventDefault();
                oTable_add.fnAddData(['<input type="text" readonly class="form-control small" name="item" value="">', '<input type="text" readonly class="form-control small" name="quantity">',
                    '<input type="text" readonly class="form-control small" name="from_quantity">', '<input type="text" readonly class="form-control small" name="to_quantity">', '<input type="text" readonly class="form-control small" name="measure">', '<td><textarea  class="form-control valid" rows="1" id="maketransfer_add_note" name="note" style="width: 100%;resize: none;"></textarea></td>',
                    '<div hidden="hidden"></div><div><input type="hidden" class="form-control small" name="attach_number"></div><ul class="uploadBox" id="u' + attachCount + '"><li><span><button type="button" class="btn upload btn-default btn-icon-sm btn-rounded" data-rel="tooltip" title="Хавсаргах"><i class="fa fa-cloud-upload"></i></button></span></li></ul>',
                    '<div class="text-center"><a style="padding-right: 11px;padding-left: 11px" class="delete btn btn-icon-sm btn-rounded btn-default" href=""><i class="fa fa-times-circle"></i></a></div>'
                ]);

                var nRow = $('div#modal-maketransfer table#table-editable_add tbody tr:last-child td').parents('tr')[0];
                editRow(oTable_add, nRow);
                $('select').selectpicker();
            });

            $('div#modal-maketransfer #table-editable_add tbody a.delete').live('click', function (e) {
                e.preventDefault();

                if (confirm("&{'are_you_sure_to_remove'}") == false) {
                    return;
                }

                var nRow = $(this).parents('tr')[0];
                oTable_add.fnDeleteRow(nRow);

            });

            $('.dataTables_filter input').attr("placeholder", "&{'search'}...");

        };


        editableTable_add();


        $('button#add_submit').click(function () {
            var is = 0;
            var rowCount = 0;

            $('div#modal-maketransfer table#table-editable_add tbody tr').each(function () {
                var attachNumber = 0;

                var obj = $(this).find('td:nth-child(7) div:first-child');
                $(this).find('td:nth-child(7) ul.uploadBox li span img.imgIcon').each(function () {
                    obj.append("<input type=\"hidden\" name=\"filename\" value=" + $(this).attr('filename') + ">" +
                    "<input type=\"hidden\" name=\"filedir\" value=" + $(this).attr('filedir') + ">" +
                    "<input type=\"hidden\" name=\"extension\" value=" + $(this).attr('extension') + ">" +
                    "<input type=\"hidden\" name=\"filesize\" value=" + $(this).attr('filesize') + ">");
                    attachNumber++;
                });
                $(this).find('td:nth-child(7) div:nth-child(2) input:first-child').val(attachNumber);
            });

            $('div#modal-maketransfer table#table-editable_add tbody tr').each(function () {
                if ($(this).find("td.dataTables_empty").val() == null) {
                    if ($(this).find('td:first-child select').val() == null || $(this).find('td:first-child select').val() == "")
                        is = 1;
                    if ($(this).find('td:nth-child(2) input').val() == "")
                        is = 1;
                    rowCount++;
                }
            });

            if ($('select#reciever_add').val() == null || $('select#reciever_add').val() == "" || $('select#location_from_add').val() == null || $('select#location_from_add').val() == "" || $('select#location_to_add').val() == null || $('select#location_to_add').val() == "")
                is = 1;
            if (rowCount == 0) {
                showErrorMessage("Мөр нэмнэ үү?");
                return;
            } else if (is == 1) {
                showErrorMessage("Шаардлагатай нүдийг бөглөнө үү?");
            }
            else if ($('select#location_from_add').val() == $('select#location_to_add').val()) {
                showErrorMessage("Хүлээн авах байршил шилжүүлэх байршилтай ижил байж болохгүй.");
            }
            else{
                $.ajax({
                    type: "POST",
                    data: $('div#modal-maketransfer form').serialize(),
                    url: "/inventorytransferstransferitem"
                }).complete(
                        function () {
                            location.reload();
                        });
            }

        });


        var startDate = $('input#filter_start');
        var endDate = $('input#filter_end');


        $('#reportrange').daterangepicker({
                    ranges: {
                        'Өнөөдөр': [moment(), moment()],
                        'Өчигдөр': [moment().subtract('days', 1), moment().subtract('days', 1)],
                        'Сүүлийн 7 хоног': [moment().subtract('days', 6), moment()],
                        'Сүүлийн 30 хоног': [moment().subtract('days', 29), moment()],
                        'Энэ сар': [moment().startOf('month'), moment().endOf('month')],
                        'Өнгөрсөн сар': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
                    },
                    startDate: moment().subtract('days', 29),
                    endDate: moment(),
                    format: 'YYYY/MM/DD',
                    locale: {
                        applyLabel: 'Болсон',
                        cancelLabel: 'Болих',
                        fromLabel: 'Аас',
                        toLabel: 'Хүртэл',
                        customRangeLabel: 'Өөрөөр сонгох',
                        dayNames: ["Даваа", "Мягмар", "Лхагва", "Пүрэв", "Баасан", "Бямба", "Ням"],
                        daysOfWeek: ["Ня", "Да", "Мя", "Лх", "Пү", "Ба", "Бя"],
                        monthNames: ["Нэгдүгээр сар", "Хоёрдугаар cар", "Гуравдугаар сар", "Дөрөвдүгээр сар", "Тавдугаар сар", "Зургаадугаар сар", "Долоодугаар сар", "Наймдугаар сар", "Есдүгээр сар", "Аравдугаар сар", "Арваннэгдүгээр сар", "Арванхоёрдугаар сар"],
                        firstDay: 1
                    }
                },
                function (start, end) {
                    $('#reportrange span').html(start.format('YYYY/MM/DD') + '-' + end.format('YYYY/MM/DD'));
                }
        );
        $('#reportrange').on('apply.daterangepicker', function (ev, picker) {
            console.log("apply event fired, start/end dates are "
                    + picker.startDate.format('YYYY/MM/DD')
                    + "-"
                    + picker.endDate.format('YYYY/MM/DD')
            );
            startDate.val(picker.startDate.format('YYYY/MM/DD'));
            endDate.val(picker.endDate.format('YYYY/MM/DD'));
        });
        $('#reportrange').on('cancel.daterangepicker', function (ev, picker) {
            console.log("cancel event fired");
            $('#reportrange span').html("Өдрөөр хайх...");
            startDate.val("");
            endDate.val("");
        });

    });
</script>
<style>
    .panel-body {
        background-color: #FFF;
        padding: 0px;
        padding-left: 0px;
    }

    .panel-default {
        border-color: transparent;
    }

    div#main-content body, div#main-content ul, div#main-content li {
        font-size: 12px;
        font-family: Arial, Helvetica, sans-serif;
        line-height: 21px;
        text-align: left;
    }
</style>

#{AttachScriptMulti uploadPath:controllers.Consts.uploadInventoryPath/}
#{inventory-config /}
#{ImgThumbnail /}